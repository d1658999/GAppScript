# MEGA 資料分析器使用說明

## 概述

這個 Google Apps Script 專案會自動從指定的 Google Sheets 分頁取得圖表，並將這些圖表以保持原始比例的方式插入到 Google Slides 簡報中。系統支援多張投影片，每張投影片最多放置三個圖表。

**🌟 最新特色：使用 `insertSheetsChartAsImage` 方法確保圖片品質與原始圖表完全一致！**

## 目標圖表

系統會自動識別並處理以下三個特定圖表：
1. `MaxPwr - TX Power`
2. `MaxPwr - ACLR - Max(E_-1,E_+1)`
3. `MaxPwr - EVM`

## 主要特色

### 🎯 **智慧圖表篩選**
- 自動識別目標圖表
- 支援標題匹配、內容分析、位置推測

### 📐 **精確自訂樣式排版**
- **固定高度**: 1.36 英寸（97.92 點），鎖定寬高比
- **寬高比**: 5:1（符合需求規格）
- **精確位置**: 根據使用者指定的座標定位
  - 第一張圖片：X: 0.21", Y: 1.11"
  - 第二張圖片：X: 2.94", Y: 2.55"
  - 第三張圖片：X: 0.21", Y: 3.98"
- **無變形**: 嚴格保持寬高比，避免拉伸或壓縮

### 🖼️ **高品質圖片匯出**
- 使用 `insertSheetsChartAsImage` 方法
- 確保輸出圖片與原始圖表完全一致
- 自動處理臨時檔案清理

### 📄 **多投影片支援**
- 每張投影片最多放置 3 個圖表
- 自動建立多張投影片容納所有圖表
- 投影片標題包含頁碼資訊

### 🎨 **優化排版設計**
- 根據圖表數量自動選擇最佳排版
- 1 張圖表：居中顯示
- 2 張圖表：垂直排列
- 3 張圖表：緊湊垂直排列

## 檔案結構

- `analyze_mega_data.gs` - 主要功能實作
- `download_charts.gs` - 圖表下載功能
- `demo.gs` - 示範和測試函式
- `test_runner.gs` - 測試套件
- `appsscript.json` - 專案設定檔
- `README.md` - 使用說明文件

## 使用步驟

### 1. 設定權限

確保您的 Google Apps Script 專案有以下權限：
- Google Sheets API
- Google Slides API  
- Google Drive API

### 2. 執行分析

在 Google Apps Script 編輯器中：

**一鍵執行（推薦）：**
1. 開啟 `analyze_mega_data.gs` 檔案
2. 執行 `executeAnalysis()` 函式
3. 這會自動完成所有步驟

**主要分析功能：**
1. 執行 `analyzeMegaData()` 函式
2. 系統會自動處理所有步驟

首次執行時會要求授權，請同意所有權限要求。

### 3. 測試功能

- `testConnections()` - 快速測試連線

可以使用以下測試函式：

- `executeAnalysis()` - **🌟 推薦**：一鍵執行所有步驟
- `testChartFiltering()` - 測試圖表識別功能（不建立投影片）
- `testCustomStyleLayout()` - **🌟 新增**：測試自訂樣式排版設定

## 主要功能

### `executeAnalysis()`
- **一鍵執行**所有分析步驟
- 提供詳細的執行報告
- 自動產生執行結果摘要

### `analyzeMegaData()`
- 從 Google Sheets 的 `[NR_TX_LMH]Summary&NR_Test_1` 分頁取得所有圖表
- 智慧識別三個目標圖表
- 使用 `insertSheetsChartAsImage` 將圖表轉換為高品質圖片
- 在 Google Slides 中建立適當數量的新投影片
- 以 5:1 寬高比插入圖片，每張投影片最多 3 個圖表

### `exportChartAsImageCorrectly()`
- **核心圖片匯出功能**
- 建立臨時 Google Slides
- 使用 `insertSheetsChartAsImage` 確保圖片品質
- 自動清理臨時檔案

### `createSlidesWithCharts()`
- 支援多張投影片建立
- 自動計算所需投影片數量
- 為每張投影片添加頁碼標題

### `calculateProportionalLayout()`
- **精確自訂樣式排版**（根據使用者要求）
- 固定高度 1.36 英寸，5:1 寬高比
- 使用指定的座標位置
- 支援 1-3 張圖表的精確定位

### `filterTargetCharts()`
- 通過多種方法識別目標圖表：
  - 圖表標題匹配
  - 資料範圍內容分析
  - 位置推測
- 自動排序圖表順序

### `testConnections()`
- 測試與 Google Sheets 和 Google Slides 的連線
- 檢查目標分頁是否存在
- 統計並顯示找到的目標圖表

## 設計特色

### 🖼️ **高品質圖片匯出**
- 使用 Google Apps Script 建議的 `insertSheetsChartAsImage` 方法
- 建立臨時 Slides 進行圖片轉換
- 確保輸出圖片與 Google Sheets 中的原始圖表完全一致
- 自動清理臨時檔案，避免 Drive 空間浪費

### 📐 **精確自訂樣式排版**
- **固定尺寸**: 每張圖片高度 1.36 英寸，寬度根據 5:1 比例計算
- **精確位置**: 使用指定的座標系統
  - 第一張：(0.21", 1.11")
  - 第二張：(2.94", 2.55")  
  - 第三張：(0.21", 3.98")
- **鎖定比例**: 嚴格保持 5:1 寬高比
- **無變形**: 避免任何拉伸或壓縮

### 🎨 **自訂樣式排版**
- **單張圖表**: 位置 (0.21", 1.11")
- **兩張圖表**: 第一張 (0.21", 1.11")，第二張 (2.94", 2.55")
- **三張圖表**: 依序使用所有三個指定位置
- **固定尺寸**: 每張圖片都是 1.36" 高，5:1 比例

### 📄 **智慧投影片管理**
- 每張投影片最多 3 個圖表
- 自動分頁處理更多圖表
- 投影片標題包含頁碼 (例: "標題 (1/2)")
- 標題樣式：Arial 18px 粗體藍色

### 🧠 **智慧圖表識別**
- 多層次識別策略
- 自動標題精確化
- 位置推測備援機制
- 確保正確的圖表順序

## 設定項目

在 `analyze_mega_data.gs` 檔案頂部的常數區域：

```javascript
const SPREADSHEET_ID = '1nnzLzALFvtwW0Lz8aVGCw7O0iaPXwN3_wRUF3BC2iak';
const PRESENTATION_ID = '1_zV6grTwFms2a0jE2i9Tz0X6mjbnCpZk8VDKIyBLxi8';
const TARGET_SHEET_NAME = '[NR_TX_LMH]Summary&NR_Test_1';
const SLIDE_TITLE = 'MEGA 資料分析 - NR TX LMH 測試結果';

const TARGET_CHART_TITLES = [
  'MaxPwr - TX Power',
  'MaxPwr - ACLR - Max(E_-1,E_+1)', 
  'MaxPwr - EVM'
];

const MAX_CHARTS_PER_SLIDE = 3; // 每個投影片最多放三張圖片
```

## 智慧圖表識別

系統使用多層次的圖表識別方法：

1. **標題匹配** - 直接比對圖表標題
2. **內容分析** - 分析圖表的資料範圍內容
3. **位置推測** - 根據圖表在分頁中的位置推測
4. **標題精確化** - 自動改善圖表標題的準確性

## 注意事項

1. **權限要求**: 確保您對指定的 Google Sheets 和 Google Slides 有編輯權限
2. **圖表格式**: 只能處理 Google Sheets 內建的圖表，不支援插入的圖片
3. **5:1 比例**: 所有圖表都會嚴格按照 5:1 寬高比排版
4. **投影片限制**: 每張投影片最多放置 3 個圖表，超過會自動建立新投影片
5. **圖表識別**: 系統會智慧識別目標圖表，即使標題不完全匹配也能正確處理
6. **錯誤處理**: 所有錯誤都會記錄在日誌中，請檢查執行日誌以診斷問題
7. **圖片品質**: 使用 `insertSheetsChartAsImage` 確保最高品質，但會建立臨時檔案

## 疑難排解

### 常見錯誤

1. **權限不足**: 確認已授權所有必要的 API 權限
2. **找不到分頁**: 檢查 `TARGET_SHEET_NAME` 是否正確
3. **沒有找到目標圖表**: 使用 `testChartFiltering()` 檢查圖表識別
4. **圖片插入失敗**: 可能是圖表格式不相容，檢查日誌獲取詳細錯誤
5. **臨時檔案問題**: 系統會自動清理，但如遇問題請檢查 Drive 垃圾桶

### 除錯技巧

1. 使用 `Logger.log()` 查看執行過程
2. 先執行 `testConnections()` 確認基本設定
3. 使用 `testChartFiltering()` 測試圖表識別功能
4. 檢查 Google Apps Script 的執行日誌
5. 確認 Google Sheets 和 Slides 的分享設定

## 開發指南

### 程式碼規範

- 遵循 Google Apps Script 最佳實踐
- 使用 V8 Runtime
- 所有函式都有 JSDoc 註解
- 錯誤處理使用 try/catch 結構
- 中文註解和日誌

### 擴展功能

如需新增功能，請：

1. 在對應的 `.gs` 檔案中新增函式
2. 添加適當的 JSDoc 註解，包含權限要求
3. 更新 `appsscript.json` 中的權限範圍（如需要）
4. 在此文件中更新使用說明

## 版本資訊

- 版本: 5.0.0
- 建立日期: 2025-08-13
- 更新日期: 2025-08-13
- 作者: GitHub Copilot
- 相容性: Google Apps Script V8 Runtime

## 更新歷史

### v5.0.0 (2025-08-13)
- 🎯 **精確自訂樣式排版** - 實作使用者指定的位置和尺寸
- � **固定高度 1.36 英寸** - 鎖定寬高比，避免變形
- 📍 **精確座標定位** - 使用指定的 X、Y 座標
- 🧪 **新增測試函式** - `testCustomStyleLayout()` 驗證排版設定
- 📖 **更新文件** - 反映新的自訂樣式功能

### v3.1.3 (2025-08-12)
- 📏 **固定圖表高度** - 將所有圖表高度固定為 1.4 英寸，實現更緊湊的投影片佈局
- 🎯 **優化排版** - 改善垂直排列的間距配置，提升視覺效果

### v3.1.0 (2025-08-12)
- 🖼️ **截圖樣式實現** - 根據實際截圖精確調整排版
- 📐 **5:3 寬高比優化** - 符合 Google Sheets 圖表的典型比例
- 🎨 **精確標題樣式** - 主標題藍色居中

### v3.0.0 (2025-08-12)
- 🚀 **多投影片支援** - 每張投影片最多 3 個圖表
- 📐 **原始比例保持** - 避免圖表變形和拉伸
- 🎨 **優化排版設計** - 根據圖表數量自動選擇最佳排版

### v2.0.0 (2025-08-12)
- 🎯 新增特定圖表篩選功能
- 📐 改為垂直排列佈局
- 🧠 智慧圖表識別系統

### v1.0.0 (2025-08-12)
- 🚀 初始版本發布
